---
name: ci

"on":
  pull_request:
    branches:
      - master
      - main
      - develop
  push:
    branches:
      - master
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.6 # Not needed with a .ruby-version file
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
      - name: Run make test
        run: |
          bundle exec make test
  bootstrap:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-11]
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Add --no-document to .gemrc
        run: |
          tee -a $HOME/.gemrc <<EOGEMRC
          install: --no-document
          update: --no-document
          EOGEMRC
      - uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Add SSH_AUTH_SOCK to root shell .profile
        run: |
          sudo tee -a ~root/.profile <<EOPROFILE
          SSH_AUTH_SOCK=${{ env.SSH_AUTH_SOCK }}
          EOPROFILE
      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          cache-version: 1
      - name: Set BREWFILE_PATH env var
        run: echo "BREWFILE_PATH=${RUNNER_TEMP}/Brewfile" >> $GITHUB_ENV
      - name: Debug GitHub Cache Paths BREWFILE_PATH
        run: |
          echo BREWFILE_PATH=$BREWFILE_PATH
          echo GITHUB_WORKSPACE=$GITHUB_WORKSPACE
      - name: Generate Brewfile from soloistrc
        run: |
          pushd test/fixtures/
          bundle exec ../../bin/convert_soloistrc_to_brewfile.rb
          popd
      - name: Configure Homebrew cache
        uses: actions/cache@v2
        with:
          path: |
            ~/Library/Caches/Homebrew/*--*
            ~/Library/Caches/Homebrew/downloads/*--*
            /usr/local/Homebrew/Library/Taps/**
            /opt/Homebrew/Library/Taps/**
          key: brew-${{ hashFiles( env.BREWFILE_PATH, '**/Brewfile.lock.json') }}
          restore-keys: brew-
      - name: Disable checksum offloading
        # See: https://github.com/actions/virtual-environments/issues/1187#issuecomment-696195756
        run: |
          sudo sysctl -w net.link.generic.system.hwcksum_tx=0
          sudo sysctl -w net.link.generic.system.hwcksum_rx=0
      - name: Run bootstrap.sh + soloist with test fixtures
        run: |
          make bootstrap
