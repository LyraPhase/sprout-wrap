#!/usr/bin/env ruby
require 'erb'
require 'yaml'

# Minimal ERB rendering class
# Reference: https://www.garethrees.co.uk/2014/01/12/create-a-template-rendering-class-with-erb/
class SoloistrcToBrewfile < ERB
  def self.template
   brewfile_erb_template = <<-EOBREWFILE
  <% for @tap in @taps do %>tap '<%= @tap.split(' ').join("', '") %>'
  <% end  %>
  
  <% for  @formula in @formulas %>brew '<%= @formula %>'
  <% end  %>
  
  <% for  @cask in @casks %>cask '<%= @cask %>'
  <% end  %>
EOBREWFILE
  end

  def initialize(soloistrc_path = 'soloistrc', options = {trim_mode: '-'})
    @soloistrc = YAML.load(File.open(soloistrc_path))

    @taps     = @soloistrc['node_attributes']['homebrew']['taps']
    @casks    = @soloistrc['node_attributes']['homebrew']['casks']
    @formulas = @soloistrc['node_attributes']['homebrew']['formulas']

    @template = options.fetch(:template, self.class.template)
    super(@template)
  end

  def result
    super(binding)
  end
end


# Set Soloist Config Paths
brewfile_out_path = ENV['RUNNER_TEMP'] || '/tmp'

brewfile_out_path = File.join(brewfile_out_path, 'Brewfile')

# Extract & Convert Homebrew node_attribute data
brewfile = SoloistrcToBrewfile.new('soloistrc')
output = brewfile.result()

soloistrc = brewfile.instance_variable_get(:@soloistrc)

puts "Soloist ['node_attributes']['homebrew']:"
puts "==> Taps"
puts soloistrc['node_attributes']['homebrew']['taps']
puts ""
puts "==> Casks"
puts soloistrc['node_attributes']['homebrew']['casks']
puts ""
puts "==> Formulas"
puts soloistrc['node_attributes']['homebrew']['formulas']
puts ""

# Write out Brewfile
puts "Writing Persistent /tmp/chef-solo.rb from soloist config"
File.open(brewfile_out_path, 'w') do |f|
  f.write(output)
end

puts "How to Run Homebrew to install Brewfile items generated by this script:"
puts ""
puts "brew bundle install --file #{brewfile_out_path}"
